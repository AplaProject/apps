{
    "name": "Trade APL",
    "conditions": "ContractConditions(\"MainCondition\")",
    "data": [
        {
            "Name": "admin_menu",
            "Conditions": "ContractAccess(\"@1EditMenu\")",
            "Value": "MenuItem(Title:$@1ta_settings$, Page:ta_settings, Icon:\"icon-wrench\")",
            "Type": "menu"
        },
        {
            "Name": "default_menu",
            "Conditions": "ContractAccess(\"@1EditMenu\")",
            "Value": "MenuItem(Title:$@1ta_transfer_admin$, Page:ta_transfer_admin, Icon:\"icon-credit-card\")",
            "Type": "menu"
        },
        {
            "Name": "sales",
            "Columns": "[\n    {\n        \"conditions\": \"true\",\n        \"name\": \"key_id_buyer\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"amount\",\n        \"type\": \"money\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"currency_type\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"buyer_transferred_at\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"amount_apl\",\n        \"type\": \"money\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"key_id_sale_apl_admin\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"key_id_sale_apl_manager\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"manager_reject_comment\",\n        \"type\": \"text\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"manager_rejected_at\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"key_id_seller\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"seller_reject_comment\",\n        \"type\": \"text\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"seller_rejected_at\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"seller_transferred_at\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"created_at\",\n        \"type\": \"number\"\n    }\n]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}",
            "Type": "tables"
        },
        {
            "Name": "wallets",
            "Columns": "[\n    {\n        \"conditions\":\"true\",\n        \"name\":\"btc\",\n        \"type\":\"money\"\n    },\n    {\n        \"conditions\":\"true\",\n        \"name\":\"eth\",\n        \"type\":\"money\"\n    },\n    {\n        \"conditions\":\"true\",\n        \"name\":\"key_id_buyer\",\n        \"type\":\"number\"\n    },\n    {\n        \"conditions\":\"true\",\n        \"name\":\"created_at\",\n        \"type\":\"number\"\n    },\n    {\n        \"conditions\":\"true\",\n        \"name\":\"signed_at\",\n        \"type\":\"number\"\n    },\n    {\n        \"conditions\":\"true\",\n        \"name\":\"rejected_at\",\n        \"type\":\"number\"\n    },\n    {\n        \"conditions\":\"true\",\n        \"name\":\"key_id_signer\",\n        \"type\":\"number\"\n    }\n]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}",
            "Type": "tables"
        },
        {
            "Name": "role_sale_apl_admin",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "0",
            "Type": "app_params"
        },
        {
            "Name": "role_sale_apl_manager",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "0",
            "Type": "app_params"
        },
        {
            "Name": "role_seller_apl",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "0",
            "Type": "app_params"
        },
        {
            "Name": "role_snapswap",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "0",
            "Type": "app_params"
        },
        {
            "Name": "ta_currency_type",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "@1btc,@1eth,@1euro",
            "Type": "app_params"
        },
        {
            "Name": "default_page",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(wallets).Where({key_id_buyer:#key_id#, key_id_signer:0, rejected_at:0}).Vars(unconfirmed_wallet)\nSetVar(founder,EcosysParam(founder_account))\nDiv(content-wrapper){\n    If(#ecosystem_id#==0){\n        SetTitle(\"\")\n    }.ElseIf(#unconfirmed_wallet_id#>0){\n        Div(panel panel-primary){\n            Div(list-group-item){\n                $@1ta_hello_user_description$\n                LinkPage(Body: $@1ta_buyer_contract$, Page: ta_buyer_contract)\n            }\n        }\n    }.ElseIf(#founder#==#key_id#){\n        Div(panel panel-primary){\n            Div(list-group-item text-center){\n                P(Class: h3 m0 text-bold, Body: $@1default_main$)\n            }\n            Div(list-group-item){\n                Span(Class: h3, Body: $@1default1$)\n                Span(Class: h3 text-primary, Body: \" https://github.com/GenesisKernel/apps \")\n                Span(Class: h3, Body: $@1default2$)\n                Span(Class: h3 text-primary, Body: \" https://genesiskernel.readthedocs.io\")\n            }\n            Div(panel-footer text-right clearfix){\n                Div(pull-left){\n                    Button(Body: $@1ecosystem_parameters$, Class: btn btn-default, Page: @1params_list)\n                }.Style(margin-right: 20px;)\n                Div(pull-left){\n                    Button(Body: $@1dashboard$, Class: btn btn-default, Page: @1admin_index)\n                }\n                Button(Body: $@1import$, Class: btn btn-primary, Page: @1import_upload)\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "ta_asbl_contract",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(@1applications).Where({ecosystem:#ecosystem_id#, name:\"Trade APL\"}).Columns(\"id\").Vars(application)\nIf(#notific_id#>0){\n    DBFind(@1notifications, n).Where({ecosystem:#ecosystem_id#, id:#notific_id#}).Columns(\"page_params->wallet_id\").Vars(note)\n}\n\nSetVar(this_page, ta_asbl_contract)\nSetTitle(\"Страница подписи представителем роли Apla Consensus\")\nDiv(content-wrapper){\n    Div(row mt-sm){\n        Div(col-lg-10 col-lg-offset-1){\n            Form(panel panel-primary){\n                DBFind(wallets).Where({id:#note_page_params_wallet_id#, rejected_at:0}).Vars(wallet)\n                If(#wallet_id#>0){\n                    Div(panel-body){\n                        Div(){\n                            покупатель: Address(#wallet_key_id_buyer#)\n                        }\n                        Div(){\n                            дата подписания договора покупателем: DateTime(#wallet_signed_at#, \"YYYY-MM-DD HH:MI:SS\")\n                        }\n                    }\n                    Div(panel-footer){\n                        Button(Body: $@1reject$, Class: btn btn-default, Page: default_page, Contract: TaAsblAction, Params: \"Action=reject,WalletId=#note_page_params_wallet_id#\")\n                        Button(Body: $@1accept$, Class: btn btn-primary pull-right, Page: default_page, Contract: TaAsblAction, Params: \"Action=accept,WalletId=#note_page_params_wallet_id#\")\n                    }\n                }.Else{\n                    Div(panel-body){\n                        wallet не найден\n                    }\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "ta_buyer_congratulation",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(@1applications).Where({ecosystem:#ecosystem_id#, name:\"Trade APL\"}).Columns(\"id\").Vars(application)\nDBFind(@1notifications).Where({ecosystem:#ecosystem_id#, id:#notific_id#}).Columns(\"page_params->wallet_id\").Vars(note)\n\n\nSetVar(this_page, ta_buyer_congratulation)\nDiv(content-wrapper){\n    Div(row mt-sm){\n        Div(col-lg-10 col-lg-offset-1){\n            Form(panel panel-primary){\n                DBFind(wallets).Where({key_id_signer:{$neq:0}, rejected_at:0}).Vars(wallet)\n                If(#wallet_id#>0){\n                    Div(panel-body){\n                        текст, мол, спасибо, теперь вы можете перевести сумму любым способом, указанным в договоре\n                    }\n                    Div(panel-footer text-center){\n                        Button(Body: $@1readed$, Class: btn btn-primary, Page: default_page, Contract: NotificationsClose, Params: \"notific_id=#notific_id#\")\n                    }\n                }.Else{\n                    Div(panel-body){\n                        wallet не найден\n                    }\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "ta_buyer_contract",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(@1applications).Where({ecosystem:#ecosystem_id#, name:\"Trade APL\"}).Columns(\"id\").Vars(application)\nDBFind(wallets).Where({key_id_buyer:#key_id#, key_id_signer:0, rejected_at:0}).Vars(unconfirmed_wallet)\n\nSetVar(this_page, ta_buyer_contract)\nSetTitle(\"Страница с договором на которую покупатель переходит при заходе\")\nDiv(content-wrapper){\n    Div(row mt-sm){\n        Div(col-lg-10 col-lg-offset-1){\n            Form(panel panel-primary){\n                If(#unconfirmed_wallet_id#>0){\n                    Div(panel-body){\n                        текст договора будет чуть позже the text of the Treaty will be a little later текст договора будет чуть позже the text of the Treaty will be a little laterтекст договора будет чуть позже the text of the Treaty will be a little laterтекст договора будет чуть позже the text of the Treaty will be a little laterтекст договора будет чуть позже the text of the Treaty will be a little laterтекст договора будет чуть позже the text of the Treaty will be a little laterтекст договора будет чуть позже the text of the Treaty will be a little later\n                    }\n                    Div(panel-footer){\n                        Button(Body: $@1reject$, Class: btn btn-danger, Page: #this_page#, Contract: TaBuyerAction, Params: \"Action=reject\")\n                        Button(Body: $@1accept$, Class: btn btn-primary pull-right, Page: #this_page#, Contract: TaBuyerAction, Params: \"Action=accept\")\n                    }\n                }.Else{\n                    Div(panel-body){\n                        вы уже заключили договор с Apla\n                    }\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "ta_key_check",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "Form(){\n    Div(form-group){\n        Div(row){\n            Div(col-md-10 mt-sm col-md-offset-2){\n                Span(Body: LangRes(@1ta_public_key_input_des), Class: text-muted)\n            }\n        }\n        Div(row){\n            Div(col-md-2 mt-sm text-right){\n                Label(For: public_key){\n                    LangRes(@1pub_key)\n                }\n            }\n            Div(col-md-10 mt-sm){\n                Input(Name: public_key, Type: textarea)\n            }\n        }\n    }\n    Div(row mt){\n        Div(col-md-12){\n            Button(Body: LangRes(@1back), Class: btn btn-default, Page: @1ta_transfer_admin)\n            Button(Body: LangRes(@1send), Class: btn btn-primary pull-right, Page: @1ta_transfer_admin, Contract: @1TaKeyCheck).Alert(Text: $@1want_add_investor$, ConfirmButton: $@1yes$, CancelButton: $@1no$, Icon: question)\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "ta_notification",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(@1applications).Where({ecosystem:#ecosystem_id#, name:\"Trade APL\"}).Columns(\"id\").Vars(application)\nIf(#notific_id#>0){\n    DBFind(@1notifications).Where({ecosystem:#ecosystem_id#, id:#notific_id#}).Columns(\"notification->header,notification->body,id\").Vars(note)\n}\n\nDiv(content-wrapper){\n    Div(row mt-sm){\n        Div(col-lg-10 col-lg-offset-1){\n            Form(panel panel-primary){\n                DBFind(wallets).Where({key_id_signer:{$neq:0}, rejected_at:0}).Vars(wallet)\n                If(#note_id#>0){\n                    Div(panel-body){\n                        Div(){\n                            #note_notification_header#\n                        }\n                        Div(){\n                            #note_notification_body#\n                        }\n                    }\n                    Div(panel-footer text-center){\n                        Button(Body: $@1readed$, Class: btn btn-primary, Page: default_page, Contract: NotificationsClose, Params: \"notific_id=#notific_id#\")\n                    }\n                }.Else{\n                    Div(panel-body){\n                        Оповещение не найдено\n                    }\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "ta_reject",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(@1applications).Where({ecosystem:#ecosystem_id#, name:\"Trade APL\"}).Columns(\"id\").Vars(application)\n\nSetVar(needed_role_id,0)\nIf(GetVar(RoleParam)!=\"\"){\n    SetVar(needed_role_id, AppParam(App:#application_id#, Name:#RoleParam#, Ecosystem: #ecosystem_id#))\n}\nIf(GetVar(notific_id)!=\"\"){\n    DBFind(@1notifications).Where({ecosystem:#ecosystem_id#, id:#notific_id#}).Columns(\"page_params->sale_id\").Vars(note)\n}\nSetVar(sale_id,0)\nIf(#note_page_params_sale_id#>0){\n    DBFind(sales).Where({id:#note_page_params_sale_id#}).Vars(sale)\n}\n\nDiv(content-wrapper){\n    Form(){\n        If(And(#needed_role_id#>0,#role_id#==#needed_role_id#,#sale_id#>0)){\n            Div(mb){\n                Input(Name:Comment, Type:textarea)\n            }\n            Div(){\n                Button(Body: $@1back$, Class: btn btn-default, Page: #back_page#, PageParams: \"notific_id=#notific_id#\")\n                Button(Body: $@1send$, Class: btn btn-primary pull-right, Page: default_page, Contract: TaReject, Params: \"RoleParam=#RoleParam#,NotificId=#notific_id#\")\n            }\n        }.Else{\n            Div(text-center text-muted){\n                If(And(#needed_role_id#>0,#role_id#!=#needed_role_id#)){\n                    Div(){\n                        for added comment you must be logined as role id #needed_role_id#\n                    }\n                }\n                If(#sale_id#==0){\n                    Div(){\n                        sale not found\n                    }\n                }\n            }\n            Div(){\n                Button(Body: $@1back$, Class: btn btn-default, Page: #back_page#, PageParams: \"notific_id=#notific_id#\")\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "ta_settings",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(@1applications).Where({ecosystem:#ecosystem_id#, name:\"Trade APL\"}).Columns(\"id\").Vars(application)\n\nSetVar(this_page, ta_settings).(role_admin,0).(role_manager,0).(role_seller,0)\nSetVar(role_admin, AppParam(App:#application_id#, Name:role_sale_apl_admin, Ecosystem: #ecosystem_id#))\nSetVar(role_manager, AppParam(App:#application_id#, Name:role_sale_apl_manager, Ecosystem: #ecosystem_id#))\nSetVar(role_seller, AppParam(App:#application_id#, Name:role_seller_apl, Ecosystem: #ecosystem_id#))\nSetVar(role_snapswap, AppParam(App:#application_id#, Name:role_snapswap, Ecosystem: #ecosystem_id#))\n\nDBFind(@1roles,src_roles).Where({ecosystem:#ecosystem_id#, deleted:0}).Columns(\"role_name,id\").Limit(100)\n\nSetVar(row,\"row mt-sm\").(col_left,\"col-sm-4 text-right mt-sm\").(col_right,\"col-sm-8 text-left\")\nSetTitle($@1ta_settings$)\nDiv(content-wrapper){\n    Div(row mt-sm){\n        Div(col-lg-10 col-lg-offset-1){\n            Form(panel panel-primary){\n                Div(panel-body){\n                    Div(#row#){\n                        Div(col-sm-12 text-center text-muted){\n                            $@1ta_settings_description$\n                        }\n                    }\n                    Div(#row#){\n                        Div(#col_left#){\n                            $@1role_sale_apl_admin$\n                        }\n                        Div(#col_right#){\n                            Select(Name:RoleAdmin, Source:src_roles, NameColumn: role_name, ValueColumn: id, Value:#role_admin#)\n                        }\n                    }\n                    Div(#row#){\n                        Div(#col_left#){\n                            $@1role_sale_apl_manager$\n                        }\n                        Div(#col_right#){\n                            Select(Name:RoleManager, Source:src_roles, NameColumn: role_name, ValueColumn: id, Value:#role_manager#)\n                        }\n                    }\n                    Div(#row#){\n                        Div(#col_left#){\n                            $@1role_seller_apl$\n                        }\n                        Div(#col_right#){\n                            Select(Name:RoleSeller, Source:src_roles, NameColumn: role_name, ValueColumn: id, Value:#role_seller#)\n                        }\n                    }\n                    Div(#row#){\n                        Div(#col_left#){\n                            $@1role_snapswap$\n                        }\n                        Div(#col_right#){\n                            Select(Name:RoleSnapswap, Source:src_roles, NameColumn: role_name, ValueColumn: id, Value:#role_snapswap#)\n                        }\n                    }\n                }\n                Div(panel-footer text-center){\n                    Button(Body: $@1send$, Class: btn btn-primary, Page: #this_page#, Contract: TaSettings)\n                }\n            }\n        }\n    }\n}",
            "Menu": "admin_menu",
            "Type": "pages"
        },
        {
            "Name": "ta_transfer_admin",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(@1applications).Where({ecosystem:#ecosystem_id#, name:\"Trade APL\"}).Columns(\"id\").Vars(application)\n\nSetVar(this_page, ta_transfer_admin)\nSetVar(row,\"row mt-sm\").(col_left,\"col-sm-4 text-right\").(col_right,\"col-sm-8 text-left\")\nSetVar(admin_role_id, AppParam(App:#application_id#, Name:role_sale_apl_admin, Ecosystem: #ecosystem_id#))\nSetVar(snapswap_role_id, AppParam(App:#application_id#, Name:role_snapswap, Ecosystem: #ecosystem_id#))\n\nAppParam(App:#application_id#, Name:ta_currency_type, Ecosystem: #ecosystem_id#, Source:currency_type)\nSetTitle($@1ta_transfer_admin$)\nDiv(content-wrapper){\n    Div(row mt-sm){\n        Div(col-lg-10 col-lg-offset-1){\n            DBFind(sales, sales).Order({id:-1}).Count(sales_count).Custom(_btat){\n                If(#buyer_transferred_at#>0){\n                    DateTime(#buyer_transferred_at#, Format: YYYY-MM-DD HH:MI:SS)\n                }\n            }.Custom(_mrat){\n                If(#manager_rejected_at#>0){\n                    DateTime(#manager_rejected_at#, Format: YYYY-MM-DD HH:MI:SS)\n                }\n            }.Custom(_srat){\n                If(#seller_rejected_at#>0){\n                    DateTime(#seller_rejected_at#, Format: YYYY-MM-DD HH:MI:SS)\n                }\n            }.Custom(_stat){\n                If(#seller_transferred_at#>0){\n                    DateTime(#seller_transferred_at#, Format: YYYY-MM-DD HH:MI:SS)\n                }\n            }.Custom(_cat){\n                If(#created_at#>0){\n                    DateTime(#created_at#, Format: YYYY-MM-DD HH:MI:SS)\n                }\n            }.Custom(_apl){\n                Money(#amount_apl#)\n            }.Custom(_currency){\n                AppParam(App:#application_id#, Name:ta_currency_type, Ecosystem: #ecosystem_id#, Index: #currency_type#)\n            }\n            If(And(#snapswap_role_id#>0,#role_id#==#snapswap_role_id#)){\n                AddToolButton(Title:$@1ta_key_check$, Page: @1ta_key_check, Icon: icon-wallet).Popup(Header: $@1ta_key_check$, Width: \"50\")\n            }\n\n            If(And(#admin_role_id#>0,#role_id#==#admin_role_id#)){\n                Form(panel panel-primary){\n                    DBFind(wallets, wallets).Where({key_id_buyer:{$neq:0}, key_id_signer:{$neq:0}, rejected_at:0}).Count(wallets_count).Custom(_name){\n                        Address(#key_id_buyer#)\n                    }\n                    Div(panel-body){\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1wallet$\n                            }\n                            Div(#col_right#){\n                                If(#wallets_count#==0){\n                                    Span($@1wallets$ $@1not_founded$, text-warning)\n                                }.Else{\n                                    Select(Name:WalletId, Source:wallets, NameColumn: _name, ValueColumn: id)\n                                }\n                            }\n                        }\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1amount$\n                            }\n                            Div(#col_right#){\n                                Input(Name:Amount, Type:number)\n                            }\n                        }\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1currency_type$\n                            }\n                            Div(#col_right#){\n                                Select(Name:CurrencyType, Source:currency_type, NameColumn: name, ValueColumn: id)\n                            }\n                        }\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1amount_apl$\n                            }\n                            Div(#col_right#){\n                                Input(Name:AmountApl, Type:number)\n                            }\n                        }\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1buyer_transferred_at$\n                            }\n                            Div(#col_right#){\n                                Div(row){\n                                    Div(col-sm-6){\n                                        Input(Name:TransferredDate, Type:date)\n                                    }\n                                    Div(col-sm-6){\n                                        Input(Name:TransferredTime, Type:time)\n                                    }\n                                }\n                            }\n                        }\n                    }\n                    Div(panel-footer text-center){\n                        If(#wallets_count#==0){\n                            Button(Body: $@1send_to_check$, Class: btn btn-primary disabled, Page: #this_page#)\n                        }.Else{\n                            Button(Body: $@1send_to_check$, Class: btn btn-primary, Page: #this_page#, Contract: TaTransferAdmin)\n                        }\n                    }\n                }\n            }\n        }\n    }\n    If(#sales_count#>0){\n        Div(table-responsive){\n            Table(sales,\"$@1id$=id,$@1key_id_buyer$=key_id_buyer,$@1amount$=amount,$@1currency_type$=_currency,$@1buyer_transferred_at$=_btat,$@1amount_apl$=_apl,$@1key_id_sale_apl_admin$=key_id_sale_apl_admin,$@1key_id_sale_apl_manager$=key_id_sale_apl_manager,$@1manager_reject_comment$=manager_reject_comment,$@1manager_rejected_at$=_mrat,$@1key_id_seller$=key_id_seller,$@1seller_reject_comment$=seller_reject_comment,$@1seller_rejected_at$=_srat,$@1seller_transferred_at$=_stat,$@1created_at$=_cat\")\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "ta_transfer_manager",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(@1applications).Where({ecosystem:#ecosystem_id#, name:\"Trade APL\"}).Columns(\"id\").Vars(application)\n\nSetVar(this_page, ta_transfer_manager)\nSetVar(role_param, role_sale_apl_manager)\nSetVar(row,\"row mt-sm\").(col_left,\"col-sm-4 text-right\").(col_right,\"col-sm-8 text-left\")\nSetVar(needed_role_id, AppParam(App:#application_id#, Name:#role_param#, Ecosystem: #ecosystem_id#))\n\nSetVar(isStartProcessing,0)\nIf(#notific_id#>0){\n    DBFind(@1notifications).Where({ecosystem:#ecosystem_id#, id:#notific_id#}).Columns(\"page_params->sale_id,date_start_processing,notification->type,processing_info->member_id\").Vars(note)\n    If(#note_date_start_processing#!=\"\"){\n        SetVar(isStartProcessing,1)\n    }\n}\nSetVar(sale_id,0)\nIf(#note_page_params_sale_id#>0){\n    DBFind(sales).Where({id:#note_page_params_sale_id#}).Vars(sale)\n}\nSetTitle($@1ta_transfer_manager$)\nDiv(content-wrapper){\n    Div(row mt-sm){\n        Div(col-lg-10 col-lg-offset-1){\n            Form(panel panel-primary){\n                If(And(#needed_role_id#>0,#role_id#==#needed_role_id#,#sale_id#>0)){\n                    Div(panel-body){\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1wallet$\n                            }\n                            Div(#col_right#){\n                                #sale_key_id_buyer#\n                            }\n                        }\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1amount$\n                            }\n                            Div(#col_right#){\n                                #sale_amount#\n                            }\n                        }\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1currency_type$\n                            }\n                            Div(#col_right#){\n                                AppParam(App:#application_id#, Name:ta_currency_type, Ecosystem: #ecosystem_id#, Index: #sale_currency_type#)\n                            }\n                        }\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1amount_apl$\n                            }\n                            Div(#col_right#){\n                                Money(#sale_amount_apl#)\n                            }\n                        }\n                        Div(#row# text-muted){\n                            Div(#col_left#){\n                                $@1buyer_transferred_at$\n                            }\n                            Div(#col_right#){\n                                DateTime(#sale_buyer_transferred_at#, Format: YYYY-MM-DD HH:MI:SS)\n                            }\n                        }\n                        Div(#row# text-muted){\n                            Div(#col_left#){\n                                $@1created_at$\n                            }\n                            Div(#col_right#){\n                                DateTime(#sale_created_at#, Format: YYYY-MM-DD HH:MI:SS)\n                            }\n                        }\n                        Div(#row# text-muted){\n                            Div(#col_left#){\n                                $@1created_by$\n                            }\n                            Div(#col_right#){\n                                Address(#sale_key_id_sale_apl_admin#)\n                            }\n                        }\n                    }\n                    Div(panel-footer){\n                        If(And(#note_processing_info_member_id#==#key_id#,#isStartProcessing#==1)){\n                            Button(Body: $@1reject$, Class: btn btn-danger, Page: ta_reject, PageParams: \"RoleParam=#role_param#,notific_id=#notific_id#,back_page=#this_page#\").Popup(50,\"Rejected comment\")\n                            Button(Body: $@1accept$, Class: btn btn-primary pull-right, Page: default_page, Contract: TaTransferManager, Params: \"SaleId=#sale_id#,NotificId=#notific_id#\")\n                        }.ElseIf(#isStartProcessing#==1){\n                            Div(text-muted text-center){\n                                process begin another manager\n                            }\n                        }.ElseIf(#isStartProcessing#==0){\n                            Div(text-center){\n                                Button(Body: $@1processing$, Class: btn btn-primary, Page: #this_page#, PageParams: \"notific_id=#notific_id#\", Contract: @1NotificationsProcess, Params: \"notific_id=#notific_id#\")\n                            }\n                        }\n                    }\n                }.Else{\n                    Div(panel-body text-center){\n                        If(#needed_role_id#>0){\n                            If(#needed_role_id#!=#role_id#){\n                                DBFind(@1app_params).Where({ecosystem:#ecosystem_id#, app_id:#application_id#, name:#role_param#}).Vars(param)\n                                Div(h4){\n                                    this page only for role from parameter LinkPage(Page: @1app_params_edit, PageParams: \"id=#param_id#,back_page=#this_page#\", Body:#role_param#)\n                                }\n                            }\n                        }.Else{\n                            Div(h4){\n                                #role_param# not setted\n                            }\n                            Div(h4){\n                                LinkPage(Body:$@1ta_settings$, Page:ta_settings)\n                            }\n                        }\n\n                        If(#note_id_page_params_sale_id#>0){\n                            If(#sale_id#>0){}.Else{\n                                sale not found\n                            }\n                        }.Else{\n                            notification not found\n                        }\n                    }\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "ta_transfer_seller",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(@1applications).Where({ecosystem:#ecosystem_id#, name:\"Trade APL\"}).Columns(\"id\").Vars(application)\n\nSetVar(this_page, ta_transfer_seller)\nSetVar(role_param, role_seller_apl)\nSetVar(row,\"row mt-sm\").(col_left,\"col-sm-4 text-right\").(col_right,\"col-sm-8 text-left\")\nSetVar(needed_role_id, AppParam(App:#application_id#, Name:#role_param#, Ecosystem: #ecosystem_id#))\n\nAppParam(App:#application_id#, Name:ta_currency_type, Ecosystem: #ecosystem_id#, Source:currency_type)\nSetVar(isStartProcessing,0)\nIf(#notific_id#>0){\n    DBFind(@1notifications).Where({ecosystem:#ecosystem_id#, id:#notific_id#}).Columns(\"page_params->sale_id,date_start_processing,notification->type,processing_info->member_id\").Vars(note)\n    If(#note_date_start_processing#!=\"\"){\n        SetVar(isStartProcessing,1)\n    }\n}\nSetVar(sale_id,0)\nIf(#note_page_params_sale_id#>0){\n    DBFind(sales).Where({id:#note_page_params_sale_id#}).Vars(sale)\n}\n\nSetTitle($@1ta_transfer_seller$)\nDiv(content-wrapper){\n    Div(row mt-sm){\n        Div(col-lg-10 col-lg-offset-1){\n            Form(panel panel-primary){\n                DBFind(wallets, wallets).Where({key_id_buyer:{$neq:0}, key_id_signer:{$neq:0}, rejected_at:0}).Vars(wallet).Custom(_name){\n                    Address(#key_id_buyer#)\n                }\n                If(And(#needed_role_id#>0,#role_id#==#needed_role_id#,#sale_id#>0)){\n                    Div(panel-body){\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1wallet$\n                            }\n                            Div(#col_right#){\n                                #sale_key_id_buyer#\n                            }\n                        }\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1amount$\n                            }\n                            Div(#col_right#){\n                                #sale_amount#\n                            }\n                        }\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1currency_type$\n                            }\n                            Div(#col_right#){\n                                AppParam(App:#application_id#, Name:ta_currency_type, Ecosystem: #ecosystem_id#, Index: #sale_currency_type#)\n                            }\n                        }\n                        Div(#row#){\n                            Div(#col_left#){\n                                $@1amount_apl$\n                            }\n                            Div(#col_right#){\n                                Money(#sale_amount_apl#)\n                            }\n                        }\n                        Div(#row# text-muted){\n                            Div(#col_left#){\n                                $@1buyer_transferred_at$\n                            }\n                            Div(#col_right#){\n                                DateTime(#sale_buyer_transferred_at#, Format: YYYY-MM-DD HH:MI:SS)\n                            }\n                        }\n                        Div(#row# text-muted){\n                            Div(#col_left#){\n                                $@1created_at$\n                            }\n                            Div(#col_right#){\n                                DateTime(#sale_created_at#, Format: YYYY-MM-DD HH:MI:SS)\n                            }\n                        }\n                        Div(#row# text-muted){\n                            Div(#col_left#){\n                                $@1created_by$\n                            }\n                            Div(#col_right#){\n                                Address(#sale_key_id_sale_apl_admin#)\n                            }\n                        }\n                        Div(#row# text-muted){\n                            Div(#col_left#){\n                                $@1checked_by$\n                            }\n                            Div(#col_right#){\n                                Address(#sale_key_id_sale_apl_manager#)\n                            }\n                        }\n                    }\n                    Div(panel-footer){\n                        If(And(#note_processing_info_member_id#==#key_id#,#isStartProcessing#==1)){\n                            Button(Body: $@1reject$, Class: btn btn-danger, Page: ta_reject, PageParams: \"RoleParam=#role_param#,notific_id=#notific_id#,back_page=#this_page#\").Popup(50,\"Rejected comment\")\n                            Button(Body: $@1accept$, Class: btn btn-primary pull-right, Page: default_page, Contract: TaTransferSeller, Params: \"SaleId=#sale_id#,NotificId=#notific_id#\")\n                        }.ElseIf(#isStartProcessing#==1){\n                            Div(text-muted text-center){\n                                process begin another seller\n                            }\n                        }.ElseIf(#isStartProcessing#==0){\n                            Div(text-center){\n                                Button(Body: $@1processing$, Class: btn btn-primary, Page: #this_page#, PageParams: \"notific_id=#notific_id#\", Contract: @1NotificationsProcess, Params: \"notific_id=#notific_id#\")\n                            }\n                        }\n                    }\n                }.Else{\n                    Div(panel-body){\n                        If(#needed_role_id#>0){\n                            If(#needed_role_id#!=#role_id#){\n                                DBFind(@1app_params).Where({ecosystem:#ecosystem_id#, app_id:#application_id#, name:#role_param#}).Vars(param)\n                                Div(h4){\n                                    this page only for role from parameter LinkPage(Page: @1app_params_edit, PageParams: \"id=#param_id#,back_page=#this_page#\", Body:#role_param#)\n                                }\n                            }\n                        }.Else{\n                            Div(h4){\n                                #role_param# not setted\n                            }\n                            Div(h4){\n                                LinkPage(Body:$@1ta_settings$, Page:ta_settings)\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "TaAsblAction",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract TaAsblAction {\n    data {\n        Action string\n        WalletId int\n    }\n    conditions{\n        var basicAppId int\n        basicAppId = Int(DBFind(\"@1applications\").Where({ecosystem:1, name:\"Basic\"}).One(\"id\"))\n        if basicAppId == 0{\n            warning LangRes(\"@1app_not_found\", \"en\")\n        }\n        $roleConsensus = Int(AppParam(basicAppId, \"role_apla_consensus_asbl\", 1))\n        if $roleConsensus == 0{\n            warning Sprintf(LangRes(\"@1role_not_set_application_parameter\", \"en\"), \"role_apla_consensus_asbl\")\n        }\n        if !RoleAccess($roleConsensus){\n            warning \"this action allowed only for role id #\" + $roleConsensus\n        }\n        $wallet = DBFind(\"wallets\").Where({id:$WalletId, rejected_at:0}).Row()\n        if !$wallet{\n            warning \"Buyer wallet not found\"\n        }\n        if Int($wallet[\"signed_at\"]) == 0{\n            warning \"Buyer wallet not signed\"\n        }\n        if $wallet[\"key_id_signer\"] > 0{\n            warning \"This wallet was signed by asbl early\"\n        }\n    }\n\n    action {\n        if $Action == \"accept\"{\n            DBUpdate(\"wallets\", Int($wallet[\"id\"]), {key_id_signer:$key_id})\n            // buyer notification\n            var params map\n            params[\"wallet_id\"] = $wallet[\"id\"]\n            @1NotificationsSend(\"member_id,sender,text_header,page_name,params_map,closure_type\", Int($wallet[\"key_id_buyer\"]), 1, \"Your wallet approved\", \"ta_buyer_congratulation\", params, 1)\n\n        }elif $Action == \"reject\"{\n            DBUpdate(\"wallets\", Int($wallet[\"id\"]), {rejected_at:$time})\n        }\n    }\n}\n",
            "Type": "contracts"
        },
        {
            "Name": "TaBuyerAction",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract TaBuyerAction {\n    data {\n        Action string\n    }\n    conditions{\n        var basicAppId int\n        basicAppId = Int(DBFind(\"@1applications\").Where({ecosystem:1, name:\"Basic\"}).One(\"id\"))\n        if basicAppId == 0{\n            warning LangRes(\"@1app_not_found\", \"en\")\n        }\n        $roleConsensus = Int(AppParam(basicAppId, \"role_apla_consensus_asbl\", 1))\n        if $roleConsensus == 0{\n            warning Sprintf(LangRes(\"@1role_not_set_application_parameter\", \"en\"), \"role_apla_consensus_asbl\")\n        }\n        $wallet = DBFind(\"wallets\").Where({key_id_buyer:$key_id, rejected_at:0}).Row()\n        if !$wallet{\n            warning \"Buyer wallet not found\"\n        }\n    }\n\n    action {\n        if $Action == \"accept\"{\n            DBUpdate(\"wallets\", Int($wallet[\"id\"]), {signed_at:$time})\n            // role Apla Consensus notification\n            var params map title string\n            title = Sprintf(\"Buyer %v signed contract\", IdToAddress($key_id))\n            params[\"wallet_id\"] = $wallet[\"id\"]\n            @1NotificationsSend(\"rid,sender,text_header,page_name,params_map,closure_type\", $roleConsensus, 1, title, \"ta_asbl_contract\", params, 1)\n\n        }elif $Action == \"reject\"{\n            DBUpdate(\"wallets\", Int($wallet[\"id\"]), {rejected_at:$time})\n        }\n    }\n}\n",
            "Type": "contracts"
        },
        {
            "Name": "TaKeyCheck",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract TaKeyCheck {\n    data {\n        public_key string\n    }\n\n    conditions {\n        if $public_key == \"\" {\n            warning LangRes(\"@1public_key_empty\", \"en\")\n        }\n\n        $public_key = Replace($public_key, \" \", \"\")\n        if HasPrefix($public_key, \"04\") {\n            $public_key = Substr($public_key, 2, Size($public_key)-2)\n        }\n        $userKey = PubToID($public_key)\n\n        if $userKey == 0 {\n            warning LangRes(\"@1public_key_invalid\", \"en\")\n        }\n        \n        if DBFind(\"wallets\").Where({key_id_buyer: $userKey}).One(\"id\") != nil {\n            warning LangRes(\"@1investor_added_already\", \"en\")\n        }\n\n        var appId snapSwapRoleId int snapSwapRoleName string\n        appId = Int(DBFind(\"@1applications\").Where({ecosystem: $ecosystem_id, name: \"Trade APL\"}).One(\"id\"))\n        if appId == 0 {\n            warning LangRes(\"@1app_not_found\", \"en\")\n        }\n\n        snapSwapRoleId = Int(AppParam(appId, \"role_snapswap\", $ecosystem_id))\n        if snapSwapRoleId == 0 {\n            warning Sprintf(LangRes(\"@1role_not_set_application_parameter\", \"en\"), \"role_snapswap\")\n        }\n        \n        snapSwapRoleName = DBFind(\"@1roles\").Where({\"id\": snapSwapRoleId}).One(\"role_name\")\n\n        if DBFind(\"@1roles_participants\").Where({\"member->member_id\": $key_id, \"role->id\": snapSwapRoleId}).One(\"id\") == nil {\n            warning Sprintf(LangRes(\"x_role_only_action\", \"en\"), snapSwapRoleName)\n        }\n    }\n\n    action {\n        var start_balance money\n        start_balance = Money(1000000000000000)\n\n        DBUpdate(\"@1keys\", $key_id, {\"-amount\": start_balance})\n        DBInsert(\"@1keys\", {\"id\": $userKey, \"amount\": start_balance})\n        DBInsert(\"wallets\", {\"key_id_buyer\": $userKey, \"created_at\": $block_time})\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "TaReject",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract TaReject {\n    data {\n        Comment string\n        RoleParam string\n        NotificId int\n    }\n    func getRoleId(name string) int{\n        var rid int\n        rid = Int(AppParam($appId, name, $ecosystem_id))\n        if rid == 0{\n            warning Sprintf(LangRes(\"@1role_not_set_application_parameter\", \"en\"), name)\n        }\n        return rid\n    }\n    conditions{\n        $appId = Int(DBFind(\"@1applications\").Where({ecosystem:$ecosystem_id, name:\"Trade APL\"}).One(\"id\"))\n        if $appId == 0{\n            warning LangRes(\"@1app_not_found\", \"en\")\n        }\n        if !($RoleParam == \"role_sale_apl_manager\" || $RoleParam == \"role_seller_apl\"){\n            warning \"invalid role parameter\"\n        }\n        var role noteSaleId int note map\n        role = getRoleId($RoleParam)\n        if !RoleAccess(role){\n            warning \"this action allowed only for role id #\" + role\n        }\n        note = DBFind(\"@1notifications\").Where({id:$NotificId}).Columns(\"page_params->sale_id,date_start_processing,notification->type\").Row()\n        if !note{\n            warning \"Notification not found\"\n        }\n        $needProcessing = note[\"date_start_processing\"] == \"\"\n        noteSaleId = Int(note[\"page_params.sale_id\"])\n        $sale = DBFind(\"sales\").Where({id:noteSaleId}).Row()\n        if !$sale {\n            warning \"Sale not found\"\n        }\n        $saleId = Int($sale[\"id\"])\n    }\n\n    action {\n        if $needProcessing {\n            @1NotificationsProcess(\"notific_id\", $NotificId)\n        }\n        @1NotificationsClose(\"notific_id\", $NotificId)\n        var sale params map title body string prevKeyId int\n        title = Sprintf(\"Sale %v rejected\", $saleId)\n        body = $Comment\n        params[\"sale_id\"] = $saleId\n\n        if $RoleParam == \"role_sale_apl_manager\"{\n            sale[\"key_id_sale_apl_manager\"] = $key_id\n            sale[\"manager_reject_comment\"] = $Comment\n            sale[\"manager_rejected_at\"] = $time\n            prevKeyId = Int($sale[\"key_id_sale_apl_admin\"])\n\n        }elif $RoleParam == \"role_seller_apl\"{\n            sale[\"key_id_seller\"] = $key_id\n            sale[\"seller_reject_comment\"] = $Comment\n            sale[\"seller_rejected_at\"] = $time\n            prevKeyId = Int($sale[\"key_id_sale_apl_manager\"])\n        }\n\n        DBUpdate(\"sales\", $saleId, sale)\n        @1NotificationsSend(\"member_id,sender,text_header,text_body,page_name,params_map,closure_type\", prevKeyId, 1, title, body, \"ta_notification\", params, 1)\n\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "TaSettings",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract TaSettings {\n    data {\n        RoleAdmin int\n        RoleManager int\n        RoleSeller int\n        RoleSnapswap int\n    }\n    conditions{\n        MainCondition()\n        $appId = Int(DBFind(\"@1applications\").Where({ecosystem:$ecosystem_id, name:\"Trade APL\"}).One(\"id\"))\n        if $appId == 0{\n            warning LangRes(\"@1app_not_found\", \"en\")\n        }\n    }\n    func updateParam(name string, id int){\n        if id > 0{\n            var params paramsNew map\n            params = DBFind(\"@1app_params\").Where({app_id:$appId, name:name, ecosystem:$ecosystem_id}).Row()\n            paramsNew[\"Id\"] = Int(params[\"id\"])\n            paramsNew[\"Value\"] = Str(id)\n            paramsNew[\"Conditions\"] = params[\"conditions\"]\n            CallContract(\"@1EditAppParam\", paramsNew)\n        }\n    }\n    action {\n        updateParam(\"role_sale_apl_admin\", $RoleAdmin)\n        updateParam(\"role_sale_apl_manager\", $RoleManager)\n        updateParam(\"role_seller_apl\", $RoleSeller)\n        updateParam(\"role_snapswap\", $RoleSnapswap)\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "TaTransferAdmin",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract TaTransferAdmin {\n    data {\n        WalletId int\n        Amount money\n        CurrencyType int\n        AmountApl money\n        TransferredDate string\n        TransferredTime string\n    }\n    func getRoleId(name string) int{\n        var rid int\n        rid = Int(AppParam($appId, name, $ecosystem_id))\n        if rid == 0{\n            warning Sprintf(LangRes(\"@1role_not_set_application_parameter\", \"en\"), name)\n        }\n        return rid\n    }\n    func trimZeroTime(s string) string {\n        if Contains(s, \"T00:00:00Z\") {\n            s = s Replace(s, \"T00:00:00Z\", \"\")\n        }\n        return s\n    }\n    func dateAddTime(d, t string) string {\n        var dt string\n        if Size(t) == 5 {\n            dt = Sprintf(\"%v %v:00\", trimZeroTime(d), t)\n        }\n        return dt\n    }\n    conditions{\n        if $AmountApl <= 0{\n            warning \"invalid amount APL\"\n        }\n        if $Amount <= 0{\n            warning \"invalid amount\"\n        }\n        $AmountApl = $AmountApl * Money(1000000000000000000)\n\n        $transferredAt = UnixDateTime(dateAddTime($TransferredDate, $TransferredTime))\n        if $transferredAt == 0 {\n            warning \"invalid transfer datetime\"\n        }\n        $appId = Int(DBFind(\"@1applications\").Where({ecosystem:$ecosystem_id, name:\"Trade APL\"}).One(\"id\"))\n        if $appId == 0{\n            warning LangRes(\"@1app_not_found\", \"en\")\n        }\n        $roleAplManager = getRoleId(\"role_sale_apl_manager\")\n        $currentRole = getRoleId(\"role_sale_apl_admin\")\n        if !RoleAccess($currentRole){\n            warning \"this action allowed only for role id #\" + $currentRole\n        }\n\n        $wallet = DBFind(\"wallets\").Where({id:$WalletId}).Row()\n        if !$wallet{\n            warning \"Buyer wallet not found\"\n        }\n        if $CurrencyType <= 0 || $CurrencyType > 3{\n            warning \"Invalid Currency Type\"\n        }\n    }\n\n    action {\n        var sale map saleId int\n        sale[\"key_id_buyer\"] = $wallet[\"key_id_buyer\"]\n        sale[\"currency_type\"] = $CurrencyType\n        sale[\"amount\"] = $Amount\n        sale[\"amount_apl\"] = $AmountApl\n        sale[\"key_id_sale_apl_admin\"] = $key_id\n        sale[\"created_at\"] = $time\n        sale[\"buyer_transferred_at\"] = $transferredAt\n\n        saleId = DBInsert(\"sales\", sale)\n\n        // role Apla sales manager notification\n        var params map title page string\n        title = Sprintf(\"Check sale id %v\", saleId)\n        page = \"ta_transfer_manager\"\n        params[\"sale_id\"] = saleId\n        @1NotificationsSend(\"rid,sender,text_header,page_name,params_map,closure_type,current_role_id\", $roleAplManager, 2, title, page, params, 1, $currentRole)\n\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "TaTransferManager",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract TaTransferManager {\n    data {\n        SaleId int\n        NotificId int\n    }\n    func getRoleId(name string) int{\n        var rid int\n        rid = Int(AppParam($appId, name, $ecosystem_id))\n        if rid == 0{\n            warning Sprintf(LangRes(\"@1role_not_set_application_parameter\", \"en\"), name)\n        }\n        return rid\n    }\n    conditions{\n        $appId = Int(DBFind(\"@1applications\").Where({ecosystem:$ecosystem_id, name:\"Trade APL\"}).One(\"id\"))\n        if $appId == 0{\n            warning LangRes(\"@1app_not_found\", \"en\")\n        }\n        $roleAplSeller = getRoleId(\"role_seller_apl\")\n        $currentRole = getRoleId(\"role_sale_apl_manager\")\n        if !RoleAccess($currentRole){\n            warning \"this action allowed only for role id #\" + $currentRole\n        }\n\n        $sale = DBFind(\"sales\").Where({id:$SaleId}).Row()\n        if !$sale{\n            warning \"Sale not found\"\n        }\n    }\n\n    action {\n        @1NotificationsClose(\"notific_id\", $NotificId)\n        DBUpdate(\"sales\", Int($sale[\"id\"]), {key_id_sale_apl_manager:$key_id})\n\n        // role Apla seller notification\n        var params map title page string\n        title = Sprintf(\"Transfer sale id %v\", $sale[\"id\"])\n        params[\"sale_id\"] = $sale[\"id\"]\n        page = \"ta_transfer_seller\"\n        @1NotificationsSend(\"rid,sender,text_header,page_name,params_map,closure_type,current_role_id\", $roleAplSeller, 2, title, page, params, 1, $currentRole)\n\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "TaTransferSeller",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract TaTransferSeller {\n    data {\n        SaleId int\n        NotificId int\n    }\n    func getRoleId(name string) int{\n        var rid int\n        rid = Int(AppParam($appId, name, $ecosystem_id))\n        if rid == 0{\n            warning Sprintf(LangRes(\"@1role_not_set_application_parameter\", \"en\"), name)\n        }\n        return rid\n    }\n    conditions{\n        $appId = Int(DBFind(\"@1applications\").Where({ecosystem:$ecosystem_id, name:\"Trade APL\"}).One(\"id\"))\n        if $appId == 0{\n            warning LangRes(\"@1app_not_found\", \"en\")\n        }\n        $currentRole = getRoleId(\"role_seller_apl\")\n        if !RoleAccess($currentRole){\n            warning \"this action allowed only for role id #\" + $currentRole\n        }\n\n        $sale = DBFind(\"sales\").Where({id:$SaleId}).Row()\n        if !$sale{\n            warning \"sale not found\"\n        }\n    }\n\n    action {\n        @1NotificationsClose(\"notific_id\", $NotificId)\n        var s transfer map\n        s[\"key_id_seller\"] = $key_id\n        s[\"seller_transferred_at\"] = $time\n        DBUpdate(\"sales\", Int($sale[\"id\"]), s)\n\n        transfer[\"Amount\"] = Money($sale[\"amount_apl\"])\n        transfer[\"Sender_AccountId\"] = $key_id\n        transfer[\"Recipient_AccountId\"] = Int($sale[\"key_id_buyer\"])\n        CallContract(\"@1TokensTransfer\", transfer)\n    }\n}",
            "Type": "contracts"
        }
    ]
}