{
    "name": "Power of attorney",
    "conditions": "ContractConditions(\"@1DeveloperCondition\")",
    "data": [
        {
            "Name": "default_menu",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "MenuItem(Title:$@1poa_list$, Page:@1poa_list, Icon:\"icon-user-following\")",
            "Type": "menu"
        },
        {
            "Name": "poa",
            "Columns": "[\r\n    {\r\n        \"name\":\"poa_sender\",\r\n        \"type\":\"json\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"date_created\",\r\n        \"type\":\"number\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"date_expiration\",\r\n        \"type\":\"number\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"deleted\",\r\n        \"type\":\"number\",\r\n        \"conditions\":\"ContractAccess(\\\"@1PoaDelete\\\")\"\r\n    },\r\n    {\r\n        \"name\":\"contract\",\r\n        \"type\":\"text\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"ecosystem\",\r\n        \"type\":\"number\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"params\",\r\n        \"type\":\"json\",\r\n        \"conditions\":\"ContractAccess(\\\"@1PoaUpdateParams\\\")\"\r\n    },\r\n    {\r\n        \"name\":\"template_id\",\r\n        \"type\":\"number\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"poa_recipient\",\r\n        \"type\":\"json\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"date_deleted\",\r\n        \"type\":\"number\",\r\n        \"conditions\":\"ContractAccess(\\\"@1PoaDelete\\\")\"\r\n    }\r\n]",
            "Permissions": "{\"insert\": \"ContractAccess(\\\"@1PoaAdd\\\")\", \"update\": \"ContractAccess(\\\"@1PoaDelete\\\",\\\"@1PoaUpdateParams\\\")\", \"new_column\": \"ContractConditions(\\\"@1AdminCondition\\\")\"}",
            "Type": "tables"
        },
        {
            "Name": "poa_templates",
            "Columns": "[\r\n    {\r\n        \"name\":\"deleted\",\r\n        \"type\":\"number\",\r\n        \"conditions\":\"ContractAccess(\\\"@1PoaTemplateDelete\\\")\"\r\n    },\r\n    {\r\n        \"name\":\"contract\",\r\n        \"type\":\"text\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"ecosystem\",\r\n        \"type\":\"number\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"date_created\",\r\n        \"type\":\"number\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"params\",\r\n        \"type\":\"json\",\r\n        \"conditions\":\"ContractAccess(\\\"@1PoaTemplateEdit\\\")\"\r\n    },\r\n    {\r\n        \"name\":\"creator\",\r\n        \"type\":\"json\",\r\n        \"conditions\":\"false\"\r\n    },\r\n    {\r\n        \"name\":\"date_deleted\",\r\n        \"type\":\"number\",\r\n        \"conditions\":\"ContractAccess(\\\"@1PoaTemplateDelete\\\")\"\r\n    }\r\n]",
            "Permissions": "{\"insert\": \"ContractAccess(\\\"@1PoaTemplateAdd\\\")\", \"update\": \"ContractAccess(\\\"@1PoaTemplateDelete\\\",\\\"@1PoaTemplateEdit\\\")\", \"new_column\": \"ContractConditions(\\\"@1AdminCondition\\\")\"}",
            "Type": "tables"
        },
        {
            "Name": "poa_add",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "Form(){\r\n    Input(Name:TemplateId, Class: hidden, Value: #template_id#)\r\n    DBFind(@1poa_templates).Vars(pre).Where({id:#template_id#,ecosystem:#ecosystem_id#})\r\n    Div(row){\r\n        Div(col-md-3 mt-sm text-right){\r\n            Label(){\r\n                LangRes(@1recipient)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            Input(Name: Recipient, Placeholder: \"xxxx-xxxx-xxxx-xxxx-xxxx\")\r\n        }\r\n    }\r\n    Div(row mt-sm){\r\n        Div(col-md-3 mt-sm text-right){\r\n            Label(){\r\n                LangRes(@1expiration_date)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            Div(row){\r\n                Div(col-md-6){\r\n                    Input(Name: DateExpiration, Type: date)\r\n                }\r\n                \r\n                Div(col-md-6){\r\n                    Input(Name: TimeExpiration, Type: time)\r\n                }\r\n            }\r\n        }\r\n    }\r\n    Div(row mt-lg){\r\n        Div(col-md-3 mt-sm text-right){\r\n            Label(){\r\n                LangRes(@1contract)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            Input(Name:ContractName, Disabled: \"true\", Value: #pre_contract#)\r\n        }\r\n    }\r\n    Div(row mt){\r\n        Div(col-md-3){}\r\n        Div(col-md-9){\r\n            Div(row){\r\n                Div(col-md-12){\r\n                    Div(row){\r\n                        Div(col-md-6){\r\n                            Span(Class: h6 m0 text-muted, Body: $@1parameter$)\r\n                        }\r\n                        Div(col-md-6){\r\n                            Span(Class: h6 m0 text-muted, Body: $@1value$)\r\n                        }\r\n                    }\r\n                    JsonToSource(pv, #pre_params#)\r\n                    ForList(Source: pv){\r\n                        Div(row mt-sm){\r\n                            Div(col-md-6){\r\n                                Input(Name: ParamArr, Value: `#key#`, Disabled: 1)\r\n                            }\r\n                            Div(col-md-6){\r\n                                Input(Name: ValueArr)\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    Button(Body: LangRes(@1add), Class: btn btn-primary pull-right mt, Page: @1poa_list, Contract: @1PoaAdd)\r\n    Button(Body: LangRes(@1back), Class: btn btn-default pull-right mt, Page: @1poa_template_list)\r\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "poa_list",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "SetVar(this_page, @1poa_list).(this_table, @1poa)\r\nInclude(@1pager_header)\r\n\r\nSetTitle(\"$@1poa_list$\")\r\nAddToolButton(Page: @1poa_template_list, Title:$@1poa_template_list$)\r\n\r\nIf(GetVar(search)){\r\n    SetVar(where, {ecosystem:#ecosystem_id#, contract:{\"$like\":#search#}, deleted:0})\r\n}.Else{\r\n    SetVar(where, {ecosystem:#ecosystem_id#, deleted:0}).(search,)\r\n}\r\n\r\nDiv(list-group-item ml-lg mr-lg pt-lg){\r\n    SetVar(search_name, LangRes(@1contract))\r\n    Include(@1search)\r\n}\r\n\r\nDBFind(#this_table#, src).Where(#where#).Order({\"id\": 1}).Limit(#pager_limit#).Offset(#pager_offset#).Columns(\"id,contract,params,date_created,date_expiration,poa_recipient->member_id,poa_recipient->member_name,poa_recipient->image_id,poa_sender->member_id,poa_sender->member_name,poa_sender->image_id,deleted\").Count(poa_count).Custom(_contract){\r\n    Span(Class: h5 text-bold, Body: #contract#)\r\n}.Custom(_creator){\r\n    If(And(#creator.member_name#!=NULL,#creator.member_name#!=\"\")){\r\n        LinkPage(Class: #style_link# text-bold, Page: @1profile_view, PageParams: \"v_key_id=#creator.member_id#\"){\r\n            #creator.member_name#\r\n        }\r\n    }\r\n}.Custom(_date_created){\r\n    Div(h6){\r\n        Div(text-nowrap){DateTime(DateTime: #date_created#, Format: \"DD.MM.YYYY HH:MI\")}\r\n    }\r\n}.Custom(_date_expiration){\r\n    Div(h6){\r\n        Div(text-nowrap){DateTime(DateTime: #date_expiration#, Format: \"DD.MM.YYYY HH:MI\")}\r\n    }\r\n}.Custom(custom_recipient){\r\n    LinkPage(Class: text-primary h5 text-bold, Page: @1profile_view, PageParams: \"v_key_id=#poa_recipient.member_id#\"){\r\n        If(#poa_recipient.image_id#>0){\r\n            Image(Src: Binary().ById(#poa_recipient.image_id#), Class: img-circle).Style(width: 30px; border: 1px solid #5A5D63; margin-right: 10px;)\r\n            Span(#poa_recipient.member_name#)\r\n        }.Else{\r\n            Div(){\r\n                Span(Em(Class: fa icon-user fa-2x)).Style(margin-right:10px;)\r\n                Span(#poa_recipient.member_name#)\r\n            }.Style(display:flex; align-items:center;)\r\n        }\r\n    }\r\n}.Custom(custom_arrow){\r\n    Em(Class: fa fa-long-arrow-right fa-1x #style_text#)\r\n}.Custom(custom_sender){\r\n    LinkPage(Class: text-primary h5 text-bold, Page: @1profile_view, PageParams: \"v_key_id=#poa_sender.member_id#\"){\r\n        If(#poa_sender.image_id#>0){\r\n            Image(Src: Binary().ById(#poa_sender.image_id#), Class: img-circle).Style(width: 30px; border: 1px solid #5A5D63; margin-right: 10px;)\r\n            Span(#poa_sender.member_name#)\r\n        }.Else{\r\n            Div(){\r\n                Span(Em(Class: fa icon-user fa-2x)).Style(margin-right:10px;)\r\n                Span(#poa_sender.member_name#)\r\n            }.Style(display:flex; align-items:center;)\r\n        }\r\n    }\r\n}.Custom(_params){\r\n    Span(Class: text-muted h6){\r\n        JsonToSource(pv, #params#)\r\n        ForList(Source: pv, Index:s_ind){\r\n            If(#s_ind#>1){\r\n                Span(\",\").Style(margin-right: 5px;)\r\n            }\r\n            \"#key#\"\r\n        }\r\n    }\r\n}.Custom(_action){\r\n    Div(text-right button-group text-nowrap){\r\n        If(#poa_sender.member_id#==#key_id#){\r\n            If(#deleted# == 0){\r\n                Button(Class: fa fa-trash btn btn-danger mh-sm, Contract: @1PoaDelete, Params: \"PoaeId=#id#\", Page: #this_page#).Alert(Text: \"$@1sure_want_delete$\", ConfirmButton: $@1yes$, CancelButton: $@1no$, Icon: question)\r\n            }\r\n        }\r\n        Button(Class: icon-eye btn btn-default mh-sm, PageParams: \"poa_id=#id#\", Page: @1poa_view).Popup(50, $@1poa_list$)\r\n    }\r\n}.Count(count)\r\n\r\nDiv(fullscreen){\r\n    Div(table-responsive ml-lg mr-lg){\r\n        Div(list-group-item){\r\n            If(#count# > 0){\r\n                Table(src, \"$@1contract$=_contract,$@1sender$=custom_sender,=custom_arrow,$@1recipient$=custom_recipient,$@1params$=_params,$@1date_created$=_date_created,$@1expiration_date$=_date_expiration,=_action\")\r\n            }.Else{\r\n                Div(Class: text-center h4 text-muted, Body: \"$@1poa_list$ $@1not_founded$\")\r\n            }                       \r\n        }.Style(\r\n            margin-top:-15px;\r\n            tbody > tr:nth-of-type(odd) {\r\n                background-color: #f8f9fc;\r\n            }\r\n        )\r\n    }\r\n}\r\nDiv(mt-sm ml-lg mr-sm mb-sm){\r\n    Include(@1pager)\r\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "poa_template_add",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "Form(){\r\n    Div(row){\r\n        Div(col-md-3 mt-sm text-right){\r\n            Label(){\r\n                LangRes(@1contract)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            Input(Name:ContractName)\r\n        }\r\n    }\r\n    Div(row mt-sm){\r\n        Div(col-md-3 mt text-right){\r\n            Label(){\r\n                LangRes(@1params)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            If(GetVar(cs)==\"\"){\r\n                SetVar(cs,0)\r\n            }\r\n            If(#del# == 1){\r\n                SetVar(cs,Calculate(#cs# - 1))\r\n            }.Else{\r\n                SetVar(cs,Calculate(#cs# + 1))\r\n            }\r\n            \r\n            Range(params_range, 0, #cs#)\r\n            ForList(Source: params_range){\r\n                Div(row mt-sm){\r\n                    Div(col-md-10){\r\n                        Input(Name:ParamArr)\r\n                    }\r\n                    Div(col-md-2 text-center){\r\n                        If(#cs#==#params_range_index#){\r\n                            Button(Class:fa fa-trash btn btn-default, PageParams: \"cs=#cs#,del=1\", Page: @1poa_template_add).Popup(Header: $@1template_add$, Width: \"50\")\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            Button(Class: btn-xs btn-link mt, Page: @1poa_template_add, PageParams:\"cs=#cs#\"){\r\n                Span(Class: h5, Body: $@1add_parameter$)\r\n            }.Popup(Header: $@1template_add$, Width: \"50\")\r\n        }\r\n    }\r\n    Button(Body: LangRes(@1add), Class: btn btn-primary pull-right mt-sm, Page: @1poa_template_list, Contract: @1PoaTemplateAdd)\r\n    Button(Body: LangRes(@1back), Class: btn btn-default pull-right mt-sm, Page: @1poa_template_list)\r\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "poa_template_edit",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "Form(){\r\n    Input(Name:TemplateId, Class: hidden, Value: #template_id#)\r\n    DBFind(@1poa_templates).Vars(pre).Where({id:#template_id#,ecosystem:#ecosystem_id#})\r\n    Div(row){\r\n        Div(col-md-3 mt-sm text-right){\r\n            Label(){\r\n                LangRes(@1contract)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            Input(Name:ContractName, Disabled: \"true\", Value: #pre_contract#)\r\n        }\r\n    }\r\n    Div(row mt-sm){\r\n        Div(col-md-3 mt text-right){\r\n            Label(){\r\n                LangRes(@1params)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            JsonToSource(pv, #pre_params#)\r\n            ForList(Source: pv, Index:s_ind){\r\n                SetVar(max_sec, #s_ind#)\r\n            }\r\n            If(GetVar(cs)==\"\"){\r\n                SetVar(cs, #max_sec#)\r\n            }\r\n            If(Or(#del_flag#==1,#del_data#>0)){\r\n                SetVar(cs, Calculate(Exp:#cs#-1, Type: int))\r\n            }\r\n            \r\n            SetVar(next_sec, Calculate(Exp:#cs#+1, Type: int))\r\n            SetVar(data_sec, Calculate(Exp:#cs#-#max_sec#, Type: int))\r\n\r\n            ForList(Source: pv, Index:s_ind){\r\n                If(#s_ind#>#cs#){\r\n                }.Else{\r\n                    Div(row mt-sm){\r\n                        Div(col-md-10){\r\n                            Input(Name: ParamArr, Value: `#key#`)\r\n                        }\r\n                        Div(col-md-2 text-center){\r\n                            If(#s_ind#==#cs#){\r\n                                Button(Body: Em(Class: fa fa-trash), Class: btn btn-default, PageParams: \"template_id=#template_id#,cs=#cs#,del_data=#s_ind#\", Page: @1poa_template_edit).Popup(Header: $@1template_edit$, Width: \"50\")\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            Range(params_range, #max_sec#, #cs#)\r\n            ForList(Source: params_range, Index:s_ind){\r\n                Div(row mt-sm){\r\n                    Div(col-md-10){\r\n                        Input(Name:ParamArr)\r\n                    }\r\n                    Div(col-md-2 text-center){\r\n                        If(#s_ind#==#data_sec#){\r\n                            Button(Body: Em(Class: fa fa-trash), Class: btn btn-default, PageParams: \"template_id=#template_id#,cs=#cs#,del_flag=1\", Page: @1poa_template_edit).Popup(Header: $@1template_edit$, Width: \"50\")\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            Button(Class: btn-xs btn-link mt, Page: @1poa_template_edit, PageParams: \"template_id=#template_id#,cs=#next_sec#\"){\r\n                Span(Class: h5, Body: $@1add_parameter$)\r\n            }.Popup(Header: $@1ecosystem$, Width: \"50\")\r\n        }\r\n    }\r\n    Button(Body: LangRes(@1save), Class: btn btn-primary pull-right mt-sm, Page: @1poa_template_list, Contract: @1PoaTemplateEdit)\r\n    Button(Body: LangRes(@1back), Class: btn btn-default pull-right mt-sm, Page: @1poa_template_list)\r\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "poa_template_list",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "SetVar(this_page, @1poa_template_list).(this_table, @1poa_templates)\r\nInclude(@1pager_header)\r\n\r\nSetTitle(\"$@1poa_template_list$\")\r\nSpan(Class: h5 m0 mb ml-lg){\r\n    LinkPage(Class: ml-sm, Body: $@1poa_list$, Page: @1poa_list)\r\n    Span(Class: text-muted mh-sm, Body: /)\r\n    Span(Class: text-muted, Body: $@1poa_template_list$)\r\n}.Style(\r\n    display: inline-block;\r\n)\r\nSetVar(admin_role_id, EcosysParam(Name:role_admin))\r\nIf(And(#admin_role_id#>0,#role_id#==#admin_role_id#)){\r\n    AddToolButton(Page: @1poa_template_add, Title: $@1template_add$).Popup(Header: $@1template_add$, Width: \"50\")\r\n}\r\n\r\nIf(GetVar(search)){\r\n    SetVar(where, {ecosystem:#ecosystem_id#, contract:{\"$like\":#search#}, deleted:0})\r\n}.Else{\r\n    SetVar(where, {ecosystem:#ecosystem_id#, deleted:0}).(search,)\r\n}\r\n\r\nDiv(list-group-item ml-lg mr-lg pt-lg){\r\n    SetVar(search_name, LangRes(@1contract))\r\n    Include(@1search)\r\n}\r\n\r\nDBFind(#this_table#, src).Where(#where#).Order({\"id\": 1}).Limit(#pager_limit#).Offset(#pager_offset#).Columns(\"id,contract,params,creator->member_id,creator->member_name,date_created,deleted\").Count(templates_count).Custom(_contract){\r\n    Button(Class: btn-xs btn-link, PageParams: \"template_id=#id#\", Page: @1poa_add){\r\n        Span(Class: h5 text-bold, Body: #contract#)\r\n    }.Popup(50, $@1poa_add$)\r\n}.Custom(_creator){\r\n    If(And(#creator.member_name#!=NULL,#creator.member_name#!=\"\")){\r\n        LinkPage(Class: text-primary, Page: @1profile_view, PageParams: \"v_key_id=#creator.member_id#\"){\r\n            #creator.member_name#\r\n        }\r\n    }\r\n}.Custom(_date){\r\n    Div(h6){\r\n        Div(text-nowrap){DateTime(DateTime: #date_created#, Format: \"DD.MM.YYYY HH:MI\")}\r\n    }\r\n}.Custom(_params){\r\n    Span(Class: text-muted h6){\r\n        JsonToSource(pv, #params#)\r\n        ForList(Source: pv, Index:s_ind){\r\n            If(#s_ind#>1){\r\n                Span(\",\").Style(margin-right: 5px;)\r\n            }\r\n            \"#key#\"\r\n        }\r\n    }\r\n}.Custom(_action){\r\n    If(#creator.member_id#==#key_id#){\r\n        Div(text-right button-group text-nowrap){\r\n            If(#deleted# == 0){\r\n                Button(Class: fa fa-trash btn btn-danger mh-sm, Contract: @1PoaTemplateDelete, Params: \"TemplateId=#id#\", Page: #this_page#).Alert(Text: \"$@1sure_want_delete$\", ConfirmButton: $@1yes$, CancelButton: $@1no$, Icon: question)\r\n            }\r\n            Button(Class: fa fa-edit btn btn-default mh-sm, PageParams: \"template_id=#id#\", Page: @1poa_template_edit).Popup(50, $@1template_edit$)\r\n        }\r\n    }\r\n}.Count(count)\r\n\r\nDiv(fullscreen){\r\n    Div(table-responsive ml-lg mr-lg){\r\n        Div(list-group-item){\r\n            If(#count# > 0){\r\n                Table(src, \"$@1contract$=_contract,$@1date_created$=_date,$@1creator$=_creator,$@1params$=_params,=_action\")\r\n            }.Else{\r\n                Div(Class: text-center h4 text-muted, Body: \"$@1poa_template_list$ $@1not_founded$\")\r\n            }                       \r\n        }.Style(\r\n            margin-top:-15px;\r\n            tbody > tr:nth-of-type(odd) {\r\n                background-color: #f8f9fc;\r\n            }\r\n        )\r\n    }\r\n}\r\nDiv(mt-sm ml-lg mr-sm mb-sm){\r\n    Include(@1pager)\r\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "poa_view",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "Form(){\r\n    Input(Name:TemplateId, Class: hidden, Value: #template_id#)\r\n    DBFind(@1poa).Vars(pre).Where({id:#poa_id#,ecosystem:#ecosystem_id#}).Columns(\"poa_sender->member_id,poa_recipient->member_id,contract,params,date_expiration\")\r\n    Div(row){\r\n        Div(col-md-3 mt-sm text-right){\r\n            Label(){\r\n                LangRes(@1sender)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            SetVar(sender_id, Address(#pre_poa_sender_member_id#))\r\n            Input(Name: Recipient, Disabled: \"true\", Value: #sender_id#)\r\n        }\r\n    }\r\n    Div(row mt-sm){\r\n        Div(col-md-3 mt-sm text-right){\r\n            Label(){\r\n                LangRes(@1recipient)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            SetVar(recipient_id, Address(#pre_poa_recipient_member_id#))\r\n            Input(Name: Recipient, Disabled: \"true\", Value: #recipient_id#)\r\n        }\r\n    }\r\n    Div(row mt-sm){\r\n        Div(col-md-3 mt-sm text-right){\r\n            Label(){\r\n                LangRes(@1expiration_date)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            SetVar(date_expiration, DateTime(DateTime: #pre_date_expiration#, Format: \"DD.MM.YYYY HH:MI\"))\r\n            Input(Name: DateExpiration, Disabled: \"true\", Value: #date_expiration#)\r\n        }\r\n    }\r\n    Div(row mt-lg){\r\n        Div(col-md-3 mt-sm text-right){\r\n            Label(){\r\n                LangRes(@1contract)\r\n            }\r\n        }\r\n        Div(col-md-9){\r\n            Input(Name:ContractName, Disabled: \"true\", Value: #pre_contract#)\r\n        }\r\n    }\r\n    Div(row mt){\r\n        Div(col-md-3){}\r\n        Div(col-md-9){\r\n            Div(row){\r\n                Div(col-md-12){\r\n                    Div(row){\r\n                        Div(col-md-6){\r\n                            Span(Class: h6 m0 text-muted, Body: $@1parameter$)\r\n                        }\r\n                        Div(col-md-6){\r\n                            Span(Class: h6 m0 text-muted, Body: $@1value$)\r\n                        }\r\n                    }\r\n                    JsonToSource(pv, #pre_params#)\r\n                    ForList(Source: pv){\r\n                        Div(row mt-sm){\r\n                            Div(col-md-6){\r\n                                Input(Name: ParamArr, Value: `#key#`, Disabled: 1)\r\n                            }\r\n                            Div(col-md-6){\r\n                                Input(Name: ValueArr, Value: `#value#`, Disabled: 1)\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    Button(Body: LangRes(@1back), Class: btn btn-default pull-right mt, Page: @1poa_list)\r\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "tokens_send",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "If(GetVar(back_page)==\"\"){\r\n    SetVar(Name: back_page, Value: \"@1members_list\")\r\n}\r\n\r\nForm(){\r\n    If(Or(#v_key_id#>0,#v_key_id#<0)){\r\n        SetVar(Name: v_address, Value: Address(#v_key_id#))\r\n    }.Else{\r\n        SetVar(Name: v_address, Value: \"\")\r\n    }\r\n    If(GetVar(v_amount)==\"\"){\r\n        SetVar(Name: v_amount, Value: \"\")\r\n    }\r\n\r\n    If(#poa# == 1){\r\n        Div(row){\r\n            Div(col-sm-3 mt-sm text-right){\r\n                Label($@1poa$)\r\n                Span(Class: text-danger, Body:*)\r\n            }\r\n            Div(col-sm-9){\r\n                Div(input-group){\r\n                    DBFind(@1poa, src_poa).Where({\"poa_recipient->member_id\":#key_id#, \"contract\":\"@1PoaTokensSend\", \"ecosystem\": #ecosystem_id#, \"deleted\":0}).Columns(\"id,poa_sender,poa_sender->member_id,params->amount_max\").Count(poa_count).Custom(_name){\r\n                        DBFind(@1keys).Where({id:#poa_sender.member_id#, \"ecosystem\": #ecosystem_id#}).Columns(\"amount\").Vars(k)\r\n                        Address(#poa_sender.member_id#) (Balance: Money(#k_amount#), Max: Money(#params.amount_max#))\r\n                    }.Custom(_id){\r\n                        #poa_sender.member_id#\r\n                    }\r\n                    If(#poa_count#>0){\r\n                        Select(Name: Sender, Source: src_poa, NameColumn: _name, ValueColumn: poa_sender.member_id)\r\n                    }.Else{\r\n                        Input(Name: SenderNF, Disabled: 1, Value: $@1poa_not_found$)\r\n                    }\r\n                    Div(input-group-btn){\r\n                        Button(Class: btn btn-primary fa fa-toggle-on, Page: @1tokens_send, PageParams: \"back_page=#back_page#,poa=0,v_key_id=#v_key_id#,v_amount=Val(Amount)\").Popup(Header: $@1tokens_send$, Width: \"50\")\r\n                    }\r\n                }\r\n                Div(Class: m0 h6 text-muted, Body: $@1send_tokens_by_poa$)\r\n            }\r\n        }\r\n    }.Else{\r\n        Div(row){\r\n            Div(col-sm-3 mt-sm text-right){\r\n                Label($@1sender$)\r\n                Span(Class: text-danger, Body:*)\r\n            }\r\n            Div(col-sm-9){\r\n                Div(input-group){\r\n                    SetVar(m_a, Address(#key_id#))\r\n                    Input(Name: Sender, Disabled: 1, Value: #m_a#)\r\n                    Div(input-group-btn){\r\n                        Button(Class: btn btn-primary fa fa-toggle-off, Page: @1tokens_send, PageParams: \"back_page=#back_page#,poa=1,v_key_id=#v_key_id#,v_amount=Val(Amount)\").Popup(Header: $@1tokens_send$, Width: \"50\")\r\n                    }\r\n                }\r\n                Div(Class: m0 h6 text-muted, Body: $@1send_tokens_my_balance$)\r\n            }\r\n        }\r\n    }\r\n    Div(row mt){\r\n        Div(col-sm-3 mt-sm text-right){\r\n            Label($@1recipient$)\r\n            Span(Class: text-danger, Body:*)\r\n        }\r\n        Div(col-sm-9){\r\n            Input(Name: Recipient, Placeholder: \"xxxx-xxxx-xxxx-xxxx-xxxx\", Value: #v_address#)\r\n        }\r\n    }\r\n    Div(row mt-sm){\r\n        Div(col-sm-3 mt-sm text-right){\r\n            Label($@1amount$)\r\n            Span(Class: text-danger, Body:*)\r\n        }\r\n        Div(col-sm-9){\r\n            Input(Name: Amount, Type: Number, Value: #v_amount#)\r\n        }\r\n    }\r\n    If(#poa# == 1){\r\n        If(#poa_count#>0){\r\n            Button(Body: LangRes(@1send), Class: btn btn-primary pull-right mt, Page: #back_page#, Contract: @1PoaTokensSend).Alert(Text: \"$@1want_send_tokens$\", ConfirmButton: $@1yes$, CancelButton: $@1no$, Icon: question)\r\n        }\r\n    }.Else{\r\n        Button(Body: LangRes(@1send), Class: btn btn-primary pull-right mt, Page: #back_page#, Contract: @1TokensSend).Alert(Text: \"$@1want_send_tokens$\", ConfirmButton: $@1yes$, CancelButton: $@1no$, Icon: question)\r\n    }\r\n    Button(Body: LangRes(@1back), Class: btn btn-default pull-right mt, Page: #back_page#)\r\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "PoaAdd",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "contract PoaAdd {\r\n    data {\r\n        Recipient string\r\n        DateExpiration string \"optional\"\r\n        TimeExpiration string \"optional\"\r\n        TemplateId int\r\n        ParamArr array\r\n        ValueArr array\r\n    }\r\n\r\n    func getMemberInfo(kid int) map {\r\n        var res member map\r\n        member = DBFind(\"@1members\").Where({ecosystem:$ecosystem_id, id:kid}).Row()\r\n        if member {\r\n            res[\"member_id\"] = member[\"id\"]\r\n            res[\"member_name\"] = member[\"member_name\"]\r\n            res[\"image_id\"] = member[\"image_id\"]\r\n        } else {\r\n            member = DBFind(\"@1keys\").Where({ecosystem:$ecosystem_id, id:kid}).Row()\r\n            if member {\r\n                res[\"member_id\"] = member[\"id\"]\r\n                res[\"member_name\"] = IdToAddress(Int(member[\"id\"]))\r\n                res[\"image_id\"] = 0\r\n            }\r\n        }\r\n        return res\r\n    }\r\n\r\n    func trimZeroTime(s string) string {\r\n        if Contains(s, \"T00:00:00Z\") {\r\n            s = s Replace(s, \"T00:00:00Z\", \"\")\r\n        }\r\n        return s\r\n    }\r\n\r\n    func dateAddTime(d, t string) string {\r\n        var dt string\r\n        if Size(t) == 5 {\r\n            dt = Sprintf(\"%v %v:00\", trimZeroTime(d), t)\r\n        }\r\n        return dt\r\n    }\r\n\r\n    conditions {\r\n        //check date\r\n        $date_expiration = dateAddTime($DateExpiration, $TimeExpiration)\r\n        if UnixDateTime($date_expiration) == 0 {        // invalid datetimes\r\n            error LangRes(\"@1invalid_expiration_date\", \"en\") \r\n        }\r\n\r\n        //check the recipient key\r\n        $recipient_id = AddressToId($Recipient)\r\n        if $recipient_id == 0 {\r\n            error Sprintf(LangRes(\"@1recipient_x_invalid\", \"en\"), $Recipient)\r\n        }\r\n\r\n        //check template\r\n        $template_map = DBFind(\"@1poa_templates\").Where({ecosystem:$ecosystem_id, id:$TemplateId}).Row()\r\n        if !$template_map {\r\n            error Sprintf(LangRes(\"@1poa_template_not_found\", \"en\"), $Recipient)\r\n        }\r\n    }\r\n    \r\n    action {\r\n        var i int params map\r\n        while i < Len($ParamArr) {\r\n            params[$ParamArr[i]] = $ValueArr[i]\r\n            i = i + 1\r\n        }\r\n        \r\n        var m map\r\n        m[\"contract\"] = $template_map[\"contract\"]\r\n        m[\"date_created\"] = $block_time \r\n        m[\"date_expiration\"] = UnixDateTime($date_expiration)\r\n        m[\"deleted\"] = 0\r\n        m[\"ecosystem\"] = $ecosystem_id\r\n        m[\"params\"] = params\r\n        m[\"poa_recipient\"] = getMemberInfo($recipient_id )\r\n        m[\"poa_sender\"] = getMemberInfo($key_id)\r\n        m[\"template_id\"] = $TemplateId\r\n        $result = DBInsert(\"@1poa\", m)\r\n    }\r\n}",
            "Type": "contracts"
        },
        {
            "Name": "PoaDelete",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "contract PoaDelete {\r\n    data {\r\n        PoaeId int\r\n    }\r\n\r\n    conditions {\r\n        var poa_map map\r\n        poa_map = DBFind(\"@1poa\").Where({\"id\":$PoaeId, \"ecosystem\":$ecosystem_id}).Columns(\"id,poa_sender->member_id\").Row()\r\n        if !poa_map {\r\n            error LangRes(\"@1poa_not_found\", \"en\") \r\n        }\r\n        if Int(poa_map[\"poa_sender.member_id\"]) != $key_id {\r\n            error LangRes(\"@1poa_not_rights_to_delete\", \"en\") \r\n        }\r\n    }\r\n\r\n    action {\r\n        var m map\r\n        m[\"deleted\"] = 1\r\n        m[\"date_deleted\"] = $block_time\r\n        DBUpdate(\"@1poa\", $PoaeId, m)\r\n    }\r\n}",
            "Type": "contracts"
        },
        {
            "Name": "PoaTemplateAdd",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "contract PoaTemplateAdd {\r\n    data {\r\n        ContractName string\r\n        ParamArr array\r\n    }\r\n\r\n    func getMemberInfo(kid int) map {\r\n        var res member map\r\n        member = DBFind(\"@1members\").Where({ecosystem:$ecosystem_id, id:kid}).Row()\r\n        if member {\r\n            res[\"member_id\"] = member[\"id\"]\r\n            res[\"member_name\"] = member[\"member_name\"]\r\n            res[\"image_id\"] = member[\"image_id\"]\r\n        } else {\r\n            member = DBFind(\"@1keys\").Where({ecosystem:$ecosystem_id, id:kid}).Row()\r\n            if member {\r\n                res[\"member_id\"] = member[\"id\"]\r\n                res[\"member_name\"] = IdToAddress(Int(member[\"id\"]))\r\n                res[\"image_id\"] = 0\r\n            }\r\n        }\r\n        return res\r\n    }\r\n\r\n    conditions {\r\n        var role_id_param string\r\n        role_id_param = EcosysParam(\"role_admin\")\r\n        if Size(role_id_param) == 0 {\r\n            error LangRes(\"@1poa_not_rights_to_create\", \"en\") \r\n        }\r\n        var role_id int\r\n        role_id = Int(role_id_param)\r\n        \r\n        if !RoleAccess(role_id) {\r\n            error LangRes(\"@1poa_not_rights_to_create\", \"en\") \r\n        }  \r\n    }\r\n    \r\n    action {\r\n        var i int params map\r\n        while i < Len($ParamArr) {\r\n            params[$ParamArr[i]] = \"\"\r\n            i = i + 1\r\n        }\r\n\r\n        var m map\r\n        m[\"creator\"] = getMemberInfo($key_id)\r\n        m[\"contract\"] = $ContractName\r\n        m[\"date_created\"] = $block_time\r\n        m[\"params\"] = params\r\n        m[\"deleted\"] = 0\r\n        m[\"ecosystem\"] = $ecosystem_id\r\n        $result = DBInsert(\"@1poa_templates\", m)\r\n    }\r\n}",
            "Type": "contracts"
        },
        {
            "Name": "PoaTemplateDelete",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "contract PoaTemplateDelete {\r\n    data {\r\n        TemplateId int\r\n    }\r\n\r\n    conditions {\r\n        var poa_map map\r\n        poa_map = DBFind(\"@1poa_templates\").Where({\"id\":$TemplateId, \"ecosystem\":$ecosystem_id}).Columns(\"id,creator->member_id\").Row()\r\n        if !poa_map {\r\n            error LangRes(\"@1poa_template_not_found\", \"en\") \r\n        }\r\n        if Int(poa_map[\"creator.member_id\"]) != $key_id {\r\n            error LangRes(\"@1poa_not_rights_to_delete\", \"en\")\r\n        }\r\n    }\r\n\r\n    action {\r\n        var m map\r\n        m[\"deleted\"] = 1\r\n        m[\"date_deleted\"] = $block_time\r\n        DBUpdate(\"@1poa_templates\", $TemplateId, m)\r\n    }\r\n}",
            "Type": "contracts"
        },
        {
            "Name": "PoaTemplateEdit",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "contract PoaTemplateEdit {\r\n    data {\r\n        TemplateId int\r\n        ParamArr array\r\n    }\r\n\r\n    conditions {\r\n        var poa_template_map map\r\n        poa_template_map = DBFind(\"@1poa_templates\").Where({\"id\":$TemplateId, \"ecosystem\":$ecosystem_id}).Columns(\"id,creator->member_id\").Row()\r\n        if !poa_template_map {\r\n            error LangRes(\"@1poa_template_not_found\", \"en\")\r\n        }\r\n        if Int(poa_template_map[\"creator.member_id\"]) != $key_id {\r\n            error LangRes(\"@1poa_not_rights_to_edit\", \"en\") \r\n        }\r\n    }\r\n    \r\n    action {\r\n        var i int params map\r\n        while i < Len($ParamArr) {\r\n            params[$ParamArr[i]] = \"\"\r\n            i = i + 1\r\n        }\r\n\r\n        var m map \r\n        m[\"params\"] = params\r\n        DBUpdate(\"@1poa_templates\", $TemplateId, m)\r\n    }\r\n}",
            "Type": "contracts"
        },
        {
            "Name": "PoaUpdateParams",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "contract PoaUpdateParams {\r\n    data {\r\n        PoaId int\r\n        ParamsStr string\r\n    }\r\n\r\n    func getPermission(cntr string) {\r\n        var prevContract string\r\n        prevContract = $stack[0]\r\n        if Len($stack) > 2 {\r\n            prevContract = $stack[Len($stack) - 2]\r\n        }\r\n        if cntr != prevContract {\r\n            error LangRes(\"@1contract_chain_distorted\", \"en\")\r\n        }\r\n    }\r\n\r\n    conditions {\r\n        var poa_map map\r\n        poa_map = DBFind(\"@1poa\").Where({\"id\": $PoaId, \"ecosystem\":$ecosystem_id, \"deleted\": 0}).Columns(\"id,date_expiration,contract,poa_recipient->member_id\").Row()\r\n\r\n        if !poa_map {\r\n            error LangRes(\"@1poa_not_found\", \"en\")\r\n        }\r\n\r\n        if Int(poa_map[\"poa_recipient.member_id\"]) != $key_id {\r\n            error LangRes(\"@1poa_not_rights_to_change\", \"en\") \r\n        }\r\n\r\n        if UnixDateTime(BlockTime()) > Int(poa_map[\"date_expiration\"]) {\r\n            error LangRes(\"@1poa_expired\", \"en\")\r\n        }\r\n\r\n        getPermission(Str(poa_map[\"contract\"]))\r\n    }\r\n    \r\n    action {\r\n        var m map\r\n        m = JSONDecode($ParamsStr)\r\n        DBUpdate(\"@1poa\", Int($PoaId), {\"params\": m})\r\n    }\r\n}",
            "Type": "contracts"
        },
        {
            "Name": "PoaTokensSend",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "contract PoaTokensSend {\r\n    data {\r\n        Amount money\r\n        Sender string\r\n        Recipient string\r\n        Comment string \"optional\"\r\n    }\r\n\r\n    func getPermission() {\r\n        var array_permissions array result i int prevContract string\r\n        array_permissions = [\"@1PoaTokensSend\"]\r\n\r\n        prevContract = $stack[0]\r\n        if Len($stack) > 2 {\r\n            prevContract = $stack[Len($stack) - 2]\r\n        }\r\n        while i < Len(array_permissions) {\r\n            var contract_name string\r\n            contract_name = array_permissions[i]\r\n            if contract_name==prevContract {\r\n                result = 1\r\n            }\r\n            i = i + 1\r\n        }\r\n\r\n        if result == 0 {\r\n            error LangRes(\"@1tokens_transfer_cannot_be_made\", \"en\")\r\n        }\r\n    }\r\n\r\n    func checkKeys() {\r\n        $sender_id = AddressToId($Sender)\r\n        $recipient_id = AddressToId($Recipient)\r\n\r\n        //check the sender key\r\n        if $sender_id == 0 {\r\n            error Sprintf(LangRes(\"@1sender_x_invalid\", \"en\"), $Sender)\r\n        }\r\n        //check the recipient key\r\n        if $recipient_id == 0 {\r\n            error Sprintf(LangRes(\"@1recipient_x_invalid\", \"en\"), $Recipient)\r\n        }\r\n    }\r\n\r\n    func checkPoa() {\r\n        var poa_map map\r\n        poa_map = DBFind(\"@1poa\").Where({\"contract\":\"@1PoaTokensSend\", \"poa_sender->member_id\": $sender_id, \"poa_recipient->member_id\":$key_id, \"ecosystem\":$ecosystem_id, \"deleted\": 0}).Columns(\"id,date_expiration,params->amount_max,params->amount_max_day,params->amount_max_month,params->amount_day,params->amount_month,params->date_day,params->date_month\").Row()\r\n        if !poa_map {\r\n            error LangRes(\"@1poa_not_found\", \"en\")\r\n        }\r\n\r\n        if UnixDateTime(BlockTime()) > Int(poa_map[\"date_expiration\"]) {\r\n            error LangRes(\"@1poa_expired\", \"en\")\r\n        }\r\n\r\n        $poa_id = poa_map[\"id\"]\r\n        $amount_max = poa_map[\"params.amount_max\"]\r\n        $amount_max_day = poa_map[\"params.amount_max_day\"]\r\n        $amount_max_month = poa_map[\"params.amount_max_month\"]\r\n        $amount_day = poa_map[\"params.amount_day\"]\r\n        $amount_month = poa_map[\"params.amount_month\"]\r\n        $date_day = poa_map[\"params.date_day\"]       // 2018-10-19 00:00:00\r\n        $date_month = poa_map[\"params.date_month\"]   // 2018-10-01 00:00:00\r\n\r\n        $cur_date_day = UnixDateTime(Substr(BlockTime(), 0, 10) + \" 00:00:00\")\r\n        $cur_date_month = UnixDateTime(Substr(BlockTime(), 0, 8) + \"01 00:00:00\")\r\n    }\r\n\r\n    func checkLimit() {\r\n        if Int($cur_date_day) > Int($date_day) {\r\n            $date_day = $cur_date_day\r\n            $amount_day = 0\r\n        }\r\n        if Int($cur_date_month) > Int($date_month) {\r\n            $date_month = $cur_date_month\r\n            $amount_month = 0\r\n        }\r\n\r\n        if Money($amount_max) < Money($Amount) {\r\n            error LangRes(\"poa_exceeded_single_limit\", \"en\")\r\n        }\r\n        if Money($amount_max_day) < Money($amount_day) + Money($Amount) {\r\n            error LangRes(\"poa_exceeded_daily_limit\", \"en\")\r\n        }\r\n        if Money($amount_max_month) < Money($amount_month) + Money($Amount) {\r\n            error LangRes(\"poa_exceeded_monthly_limit\", \"en\")\r\n        }\r\n    }\r\n\r\n    func updateParams() {\r\n        $amount_day = Money($amount_day) + Money($Amount)\r\n        $amount_month = Money($amount_month) + Money($Amount)\r\n\r\n        var m map\r\n        m[\"amount_max\"] = Str($amount_max)\r\n        m[\"amount_max_day\"] = Str($amount_max_day)\r\n        m[\"amount_max_month\"] = Str($amount_max_month)\r\n        m[\"amount_day\"] = Str($amount_day)\r\n        m[\"amount_month\"] = Str($amount_month)\r\n        m[\"date_day\"] = Str($date_day)\r\n        m[\"date_month\"] = Str($date_month)\r\n\r\n        @1PoaUpdateParams(\"PoaId,ParamsStr\", Int($poa_id), JSONEncode(m))  \r\n    }\r\n\r\n    conditions {\r\n        getPermission()\r\n        checkKeys()\r\n        checkPoa()\r\n        checkLimit()\r\n    }\r\n\r\n    action {\r\n        @1TokensTransfer(\"Amount,SenderId,RecipientId,Comment\", $Amount, $sender_id, $recipient_id, $Comment)\r\n        updateParams()\r\n    }\r\n}",
            "Type": "contracts"
        }
    ]
}